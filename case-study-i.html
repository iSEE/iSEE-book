<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Case study I | Extending iSEE</title>
  <meta name="description" content="This book describes how to use the Bioconductor iSEE package to create web-applications for exploring data stored in SummarizedExperiment objects." />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Case study I | Extending iSEE" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book describes how to use the Bioconductor iSEE package to create web-applications for exploring data stored in SummarizedExperiment objects." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Case study I | Extending iSEE" />
  
  <meta name="twitter:description" content="This book describes how to use the Bioconductor iSEE package to create web-applications for exploring data stored in SummarizedExperiment objects." />
  

<meta name="author" content="Kevin Rue-Albrecht, Federico Marini, Charlotte Soneson, and Aaron Lun" />


<meta name="date" content="2019-12-29" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="the-panel-api.html"/>
<link rel="next" href="case-study-ii.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Extending <i>iSEE</i></a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="panels.html"><a href="panels.html"><i class="fa fa-check"></i><b>1</b> Panel classes</a><ul>
<li class="chapter" data-level="1.1" data-path="panels.html"><a href="panels.html#overview"><i class="fa fa-check"></i><b>1.1</b> Overview</a></li>
<li class="chapter" data-level="1.2" data-path="panels.html"><a href="panels.html#the-panel-class"><i class="fa fa-check"></i><b>1.2</b> The Panel class</a></li>
<li class="chapter" data-level="1.3" data-path="panels.html"><a href="panels.html#the-dotplot-and-table-panel-families"><i class="fa fa-check"></i><b>1.3</b> The DotPlot and Table panel families</a></li>
<li class="chapter" data-level="1.4" data-path="panels.html"><a href="panels.html#the-columndotplot-and-rowdotplot-panel-families"><i class="fa fa-check"></i><b>1.4</b> The ColumnDotPlot and RowDotPlot panel families</a></li>
<li class="chapter" data-level="1.5" data-path="panels.html"><a href="panels.html#built-in-columndotplot-panel-classes"><i class="fa fa-check"></i><b>1.5</b> Built-in ColumnDotPlot panel classes</a></li>
<li class="chapter" data-level="1.6" data-path="panels.html"><a href="panels.html#built-in-rowdotplot-panel-classes"><i class="fa fa-check"></i><b>1.6</b> Built-in RowDotPlot panel classes</a></li>
<li class="chapter" data-level="1.7" data-path="panels.html"><a href="panels.html#the-columntable-and-rowtable-panel-families"><i class="fa fa-check"></i><b>1.7</b> The ColumnTable and RowTable panel families</a></li>
<li class="chapter" data-level="1.8" data-path="panels.html"><a href="panels.html#built-in-columntable-panel-classes"><i class="fa fa-check"></i><b>1.8</b> Built-in ColumnTable panel classes</a></li>
<li class="chapter" data-level="1.9" data-path="panels.html"><a href="panels.html#built-in-rowtable-panel-classes"><i class="fa fa-check"></i><b>1.9</b> Built-in RowTable panel classes</a></li>
<li class="chapter" data-level="1.10" data-path="panels.html"><a href="panels.html#heatmapplot-class"><i class="fa fa-check"></i><b>1.10</b> The HeatMapPlot panel class</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="server.html"><a href="server.html"><i class="fa fa-check"></i><b>2</b> The app server</a><ul>
<li class="chapter" data-level="2.1" data-path="server.html"><a href="server.html#robjects"><i class="fa fa-check"></i><b>2.1</b> Reactive objects</a></li>
<li class="chapter" data-level="2.2" data-path="server.html"><a href="server.html#persistent-non-reactive-objects"><i class="fa fa-check"></i><b>2.2</b> Persistent (non-reactive) objects</a></li>
<li class="chapter" data-level="2.3" data-path="server.html"><a href="server.html#memory"><i class="fa fa-check"></i><b>2.3</b> The app memory</a></li>
<li class="chapter" data-level="2.4" data-path="server.html"><a href="server.html#panel-api"><i class="fa fa-check"></i><b>2.4</b> The panel API</a><ul>
<li class="chapter" data-level="2.4.1" data-path="server.html"><a href="server.html#cachecommoninfo"><i class="fa fa-check"></i><b>2.4.1</b> .cacheCommonInfo</a></li>
<li class="chapter" data-level="2.4.2" data-path="server.html"><a href="server.html#refineparameters"><i class="fa fa-check"></i><b>2.4.2</b> .refineParameters</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="server.html"><a href="server.html#initialization-of-the-app-server"><i class="fa fa-check"></i><b>2.5</b> Initialization of the app server</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>3</b> The plotting API</a><ul>
<li class="chapter" data-level="3.1" data-path="plotting.html"><a href="plotting.html#getplottingfunction"><i class="fa fa-check"></i><b>3.1</b> .getPlottingFunction</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="developing.html"><a href="developing.html"><i class="fa fa-check"></i><b>4</b> Developing new panels</a></li>
<li class="chapter" data-level="5" data-path="the-panel-api.html"><a href="the-panel-api.html"><i class="fa fa-check"></i><b>5</b> The panel API</a><ul>
<li class="chapter" data-level="5.1" data-path="the-panel-api.html"><a href="the-panel-api.html#create-a-new-s4-class"><i class="fa fa-check"></i><b>5.1</b> Create a new S4 class</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="case-study-i.html"><a href="case-study-i.html"><i class="fa fa-check"></i><b>6</b> Case study I</a><ul>
<li class="chapter" data-level="6.1" data-path="case-study-i.html"><a href="case-study-i.html#overview-1"><i class="fa fa-check"></i><b>6.1</b> Overview</a></li>
<li class="chapter" data-level="6.2" data-path="case-study-i.html"><a href="case-study-i.html#class-basics"><i class="fa fa-check"></i><b>6.2</b> Class basics</a></li>
<li class="chapter" data-level="6.3" data-path="case-study-i.html"><a href="case-study-i.html#setting-up-the-interface"><i class="fa fa-check"></i><b>6.3</b> Setting up the interface</a></li>
<li class="chapter" data-level="6.4" data-path="case-study-i.html"><a href="case-study-i.html#creating-the-observers"><i class="fa fa-check"></i><b>6.4</b> Creating the observers</a></li>
<li class="chapter" data-level="6.5" data-path="case-study-i.html"><a href="case-study-i.html#making-the-plot"><i class="fa fa-check"></i><b>6.5</b> Making the plot</a></li>
<li class="chapter" data-level="6.6" data-path="case-study-i.html"><a href="case-study-i.html#finishing-touches"><i class="fa fa-check"></i><b>6.6</b> Finishing touches</a></li>
<li class="chapter" data-level="6.7" data-path="case-study-i.html"><a href="case-study-i.html#in-action"><i class="fa fa-check"></i><b>6.7</b> In action</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="case-study-ii.html"><a href="case-study-ii.html"><i class="fa fa-check"></i><b>7</b> Case study II</a><ul>
<li class="chapter" data-level="7.1" data-path="case-study-ii.html"><a href="case-study-ii.html#overview-2"><i class="fa fa-check"></i><b>7.1</b> Overview</a></li>
<li class="chapter" data-level="7.2" data-path="case-study-ii.html"><a href="case-study-ii.html#class-basics-1"><i class="fa fa-check"></i><b>7.2</b> Class basics</a></li>
<li class="chapter" data-level="7.3" data-path="case-study-ii.html"><a href="case-study-ii.html#setting-up-the-interface-1"><i class="fa fa-check"></i><b>7.3</b> Setting up the interface</a></li>
<li class="chapter" data-level="7.4" data-path="case-study-ii.html"><a href="case-study-ii.html#creating-the-observers-1"><i class="fa fa-check"></i><b>7.4</b> Creating the observers</a></li>
<li class="chapter" data-level="7.5" data-path="case-study-ii.html"><a href="case-study-ii.html#making-the-table"><i class="fa fa-check"></i><b>7.5</b> Making the table</a></li>
<li class="chapter" data-level="7.6" data-path="case-study-ii.html"><a href="case-study-ii.html#in-action-1"><i class="fa fa-check"></i><b>7.6</b> In action</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Extending <em>iSEE</em></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="case-study-i" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Case study I</h1>
<div id="overview-1" class="section level2">
<h2><span class="header-section-number">6.1</span> Overview</h2>
<p>In this case study, we will create a custom panel class to regenerate sample-level PCA coordinates using only a subset of points transmitted as a multiple column selection from another panel.
We call this a <strong>dynamic reduced dimension plot</strong>, as it is dynamically recomputing the dimensionality reduction results rather than using pre-computed values in the <code>reducedDims()</code> slot of a <code>SingleCellExperiment</code> object.</p>
</div>
<div id="class-basics" class="section level2">
<h2><span class="header-section-number">6.2</span> Class basics</h2>
<p>First, we define the basics of our new <code>Panel</code> class.
As our new class will be showing each sample as a point, we inherit from the <code>ColumnDotPlot</code> virtual class.
This automatically gives us access to all the functionality promised in the contract,
including interface elements and observers to handle multiple selections and respond to aesthetic parameters.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">library</span>(iSEE)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">setClass</span>(<span class="st">&quot;DynRedDimPlot&quot;</span>, <span class="dt">contains=</span><span class="st">&quot;ColumnDotPlot&quot;</span>,</a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="dt">slots=</span><span class="kw">c</span>(<span class="dt">NGenes=</span><span class="st">&quot;integer&quot;</span>, <span class="dt">Type=</span><span class="st">&quot;character&quot;</span>))</a></code></pre></div>
<p>We add a slot specifying the type of dimensionality reduction result and the number of highly variable genes to use.
Any new slots should also come with validity methods, as shown below.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">library</span>(S4Vectors)</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">setValidity2</span>(<span class="st">&quot;DynRedDimPlot&quot;</span>, <span class="cf">function</span>(object) {</a>
<a class="sourceLine" id="cb4-3" title="3">    msg &lt;-<span class="st"> </span><span class="kw">character</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="cf">if</span> (<span class="kw">length</span>(n &lt;-<span class="st"> </span>object[[<span class="st">&quot;NGenes&quot;</span>]])<span class="op">!=</span>1L <span class="op">||</span><span class="st"> </span>n <span class="op">&lt;</span><span class="st"> </span>1L) {</a>
<a class="sourceLine" id="cb4-6" title="6">        msg &lt;-<span class="st"> </span><span class="kw">c</span>(msg, <span class="st">&quot;&#39;NGenes&#39; must be a positive integer scalar&quot;</span>) </a>
<a class="sourceLine" id="cb4-7" title="7">    }</a>
<a class="sourceLine" id="cb4-8" title="8">    <span class="cf">if</span> (<span class="op">!</span><span class="kw">isSingleString</span>(val &lt;-<span class="st"> </span>object[[<span class="st">&quot;Type&quot;</span>]]) <span class="op">||</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="st">        </span><span class="op">!</span>val <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;PCA&quot;</span>, <span class="st">&quot;TSNE&quot;</span>, <span class="st">&quot;UMAP&quot;</span>)) </a>
<a class="sourceLine" id="cb4-10" title="10">    {</a>
<a class="sourceLine" id="cb4-11" title="11">        msg &lt;-<span class="st"> </span><span class="kw">c</span>(msg, <span class="st">&quot;&#39;Type&#39; must be one of &#39;TSNE&#39;, &#39;PCA&#39; or &#39;UMAP&#39;&quot;</span>)</a>
<a class="sourceLine" id="cb4-12" title="12">    }</a>
<a class="sourceLine" id="cb4-13" title="13"></a>
<a class="sourceLine" id="cb4-14" title="14">    <span class="cf">if</span> (<span class="kw">length</span>(msg)) {</a>
<a class="sourceLine" id="cb4-15" title="15">        <span class="kw">return</span>(msg)</a>
<a class="sourceLine" id="cb4-16" title="16">    }</a>
<a class="sourceLine" id="cb4-17" title="17">    <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb4-18" title="18">})</a></code></pre></div>
<pre><code>## Class &quot;DynRedDimPlot&quot; [in &quot;.GlobalEnv&quot;]
## 
## Slots:
##                                                                      
## Name:                NGenes                 Type       ColorByColData
## Class:              integer            character            character
##                                                                      
## Name:  ColorByFeatNameAssay ColorBySampNameColor       ShapeByColData
## Class:            character            character            character
##                                                                      
## Name:         SizeByColData           FacetByRow        FacetByColumn
## Class:            character            character            character
##                                                                      
## Name:               ColorBy  ColorByDefaultColor      ColorByFeatName
## Class:            character            character            character
##                                                                      
## Name:       ColorByRowTable      ColorBySampName      ColorByColTable
## Class:            character            character            character
##                                                                      
## Name:               ShapeBy               SizeBy         SelectEffect
## Class:            character            character            character
##                                                                      
## Name:           SelectColor          SelectAlpha             ZoomData
## Class:            character              numeric              numeric
##                                                                      
## Name:             BrushData        VisualBoxOpen        VisualChoices
## Class:                 list              logical            character
##                                                                      
## Name:            ContourAdd         ContourColor            PointSize
## Class:              logical            character              numeric
##                                                                      
## Name:            PointAlpha           Downsample            SampleRes
## Class:              numeric              logical              numeric
##                                                                      
## Name:              FontSize       LegendPosition              PanelId
## Class:              numeric            character              integer
##                                                                      
## Name:           PanelHeight           PanelWidth        SelectBoxOpen
## Class:              integer              integer              logical
##                                                                      
## Name:       SelectRowSource      SelectColSource          DataBoxOpen
## Class:            character            character              logical
##                                                                      
## Name:         SelectRowType       SelectRowSaved        SelectColType
## Class:            character              integer            character
##                                                 
## Name:        SelectColSaved   MultiSelectHistory
## Class:              integer                 list
## 
## Extends: 
## Class &quot;ColumnDotPlot&quot;, directly
## Class &quot;DotPlot&quot;, by class &quot;ColumnDotPlot&quot;, distance 2
## Class &quot;Panel&quot;, by class &quot;ColumnDotPlot&quot;, distance 3</code></pre>
<p>It is also worthwhile specializing the <code>initialize()</code> method to provide a default for new parameters:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">setMethod</span>(<span class="st">&quot;initialize&quot;</span>, <span class="st">&quot;DynRedDimPlot&quot;</span>, </a>
<a class="sourceLine" id="cb6-2" title="2">    <span class="cf">function</span>(.Object, <span class="dt">Type=</span><span class="st">&quot;PCA&quot;</span>, <span class="dt">NGenes=</span>1000L, ...) </a>
<a class="sourceLine" id="cb6-3" title="3">{</a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="kw">callNextMethod</span>(.Object, <span class="dt">Type=</span>Type, <span class="dt">NGenes=</span>NGenes, ...)</a>
<a class="sourceLine" id="cb6-5" title="5">})</a></code></pre></div>
</div>
<div id="setting-up-the-interface" class="section level2">
<h2><span class="header-section-number">6.3</span> Setting up the interface</h2>
<p>The most basic requirement is to define some methods that describe our new panel in the <code>iSEE()</code> interface.
This includes defining the full name and desired default color for display purposes:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">setMethod</span>(<span class="st">&quot;.fullName&quot;</span>, <span class="st">&quot;DynRedDimPlot&quot;</span>, <span class="cf">function</span>(x) <span class="st">&quot;Dynamic reduced dimension plot&quot;</span>)</a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">setMethod</span>(<span class="st">&quot;.panelColor&quot;</span>, <span class="st">&quot;DynRedDimPlot&quot;</span>, <span class="cf">function</span>(x) <span class="st">&quot;#0F0F0F&quot;</span>)</a></code></pre></div>
<p>We also add interface elements to change the result type and the number of genes.
This is most easily done by specializing the <code>.defineDataInterface</code> method:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">library</span>(shiny)</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">setMethod</span>(<span class="st">&quot;.defineDataInterface&quot;</span>, <span class="st">&quot;DynRedDimPlot&quot;</span>, <span class="cf">function</span>(x, se, select_info) {</a>
<a class="sourceLine" id="cb8-3" title="3">    plot_name &lt;-<span class="st"> </span><span class="kw">.getEncodedName</span>(x)</a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb8-6" title="6">        <span class="kw">selectInput</span>(<span class="kw">paste0</span>(plot_name, <span class="st">&quot;_Type&quot;</span>), <span class="dt">label=</span><span class="st">&quot;Dimensionality reduction Type&quot;</span>,</a>
<a class="sourceLine" id="cb8-7" title="7">            <span class="dt">choices=</span><span class="kw">c</span>(<span class="st">&quot;PCA&quot;</span>, <span class="st">&quot;TSNE&quot;</span>, <span class="st">&quot;UMAP&quot;</span>), <span class="dt">selected=</span>x[[<span class="st">&quot;Type&quot;</span>]]),</a>
<a class="sourceLine" id="cb8-8" title="8">        <span class="kw">numericInput</span>(<span class="kw">paste0</span>(plot_name, <span class="st">&quot;_NGenes&quot;</span>), <span class="dt">label=</span><span class="st">&quot;Number of genes&quot;</span>,</a>
<a class="sourceLine" id="cb8-9" title="9">            <span class="dt">min=</span><span class="dv">1</span>, <span class="dt">value=</span>x[[<span class="st">&quot;NGenes&quot;</span>]])</a>
<a class="sourceLine" id="cb8-10" title="10">    )</a>
<a class="sourceLine" id="cb8-11" title="11">})</a></code></pre></div>
<p>We call <code>.getEncodedName()</code> to obtain a unique name for the current instance of our panel, e.g., <code>DynRedDimPlot1</code>.
We then <code>paste0</code> the name of our panel to the name of any parameter to ensure that the ID is unique to this instance of our panel;
otherwise, multiple <code>DynRedDimPlot</code>s would override each other.
One can imagine this as a poor man’s Shiny module.</p>
</div>
<div id="creating-the-observers" class="section level2">
<h2><span class="header-section-number">6.4</span> Creating the observers</h2>
<p>We specialize <code>.createObservers</code> to define some observers to respond to changes in our new interface elements.
Note the use of <code>callNextMethod()</code> to ensure that observers of the parent class are also created;
this automatically ensures that we can respond to changes in parameters provided by <code>ColumnDotPlot</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">setMethod</span>(<span class="st">&quot;.createObservers&quot;</span>, <span class="st">&quot;DynRedDimPlot&quot;</span>, </a>
<a class="sourceLine" id="cb9-2" title="2">    <span class="cf">function</span>(x, se, input, session, pObjects, rObjects) </a>
<a class="sourceLine" id="cb9-3" title="3">{</a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="kw">callNextMethod</span>()</a>
<a class="sourceLine" id="cb9-5" title="5"></a>
<a class="sourceLine" id="cb9-6" title="6">    plot_name &lt;-<span class="st"> </span><span class="kw">.getEncodedName</span>(x)</a>
<a class="sourceLine" id="cb9-7" title="7"></a>
<a class="sourceLine" id="cb9-8" title="8">    <span class="co"># </span><span class="al">TODO</span><span class="co">: expose .define_protected_parameter_observers for developer use, </span></a>
<a class="sourceLine" id="cb9-9" title="9">    <span class="co"># which would allow these steps to be a one-liner.</span></a>
<a class="sourceLine" id="cb9-10" title="10">    type_field &lt;-<span class="st"> </span><span class="kw">paste0</span>(plot_name, <span class="st">&quot;_Type&quot;</span>)</a>
<a class="sourceLine" id="cb9-11" title="11">    <span class="kw">observeEvent</span>(input[[type_field]], {</a>
<a class="sourceLine" id="cb9-12" title="12">        previous &lt;-<span class="st"> </span>pObjects<span class="op">$</span>memory[[plot_name]][[<span class="st">&quot;Type&quot;</span>]]</a>
<a class="sourceLine" id="cb9-13" title="13">        <span class="cf">if</span> (<span class="kw">identical</span>(previous, input[[type_field]])) {</a>
<a class="sourceLine" id="cb9-14" title="14">            <span class="kw">return</span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb9-15" title="15">        }</a>
<a class="sourceLine" id="cb9-16" title="16">        pObjects<span class="op">$</span>memory[[plot_name]][[<span class="st">&quot;Type&quot;</span>]] &lt;-<span class="st"> </span>input[[type_field]]</a>
<a class="sourceLine" id="cb9-17" title="17">        <span class="kw">.requestCleanUpdate</span>(plot_name, pObjects, rObjects)</a>
<a class="sourceLine" id="cb9-18" title="18">    })</a>
<a class="sourceLine" id="cb9-19" title="19"></a>
<a class="sourceLine" id="cb9-20" title="20">    num_field &lt;-<span class="st"> </span><span class="kw">paste0</span>(plot_name, <span class="st">&quot;_NGenes&quot;</span>)</a>
<a class="sourceLine" id="cb9-21" title="21">    <span class="kw">observeEvent</span>(input[[num_field]], {</a>
<a class="sourceLine" id="cb9-22" title="22">        previous &lt;-<span class="st"> </span>pObjects<span class="op">$</span>memory[[plot_name]][[<span class="st">&quot;NGenes&quot;</span>]]</a>
<a class="sourceLine" id="cb9-23" title="23">        <span class="cf">if</span> (<span class="kw">identical</span>(previous, input[[num_field]])) {</a>
<a class="sourceLine" id="cb9-24" title="24">            <span class="kw">return</span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb9-25" title="25">        }</a>
<a class="sourceLine" id="cb9-26" title="26">        pObjects<span class="op">$</span>memory[[plot_name]][[<span class="st">&quot;NGenes&quot;</span>]] &lt;-<span class="st"> </span>input[[num_field]]</a>
<a class="sourceLine" id="cb9-27" title="27">        <span class="kw">.requestCleanUpdate</span>(plot_name, pObjects, rObjects)</a>
<a class="sourceLine" id="cb9-28" title="28">    })</a>
<a class="sourceLine" id="cb9-29" title="29">})</a></code></pre></div>
<p>Both the <code>NGenes</code> and <code>Type</code> parameters are what we consider to be “protected” parameters,
as changing them will alter the nature of the displayed plot.
By using <code>.requestCleanUpdate()</code>, we instruct <code>iSEE()</code> to destroy existing brushes and lassos when these parameters are changed,
as brushes/lassos made on the previous plot do not make sense when the coordinates are recomputed.</p>
</div>
<div id="making-the-plot" class="section level2">
<h2><span class="header-section-number">6.5</span> Making the plot</h2>
<p>When working with a <code>ColumnDotPlot</code> subclass, the easiest way to change plotting content to override the <code>.generateDotPlotData</code> method.
This should add a <code>plot.data</code> variable to the <code>envir</code> environment that has columns <code>X</code> and <code>Y</code> and contains one row per column of the original <code>SummarizedExperiment</code>.
It should also return a character vector of R commands describing how that <code>plot.data</code> object was constructed.
The easiest way to do this is to create a character vector of commands and call <code>eval(parse(text=...), envir=envir)</code> to evaluate them within <code>envir</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">setMethod</span>(<span class="st">&quot;.generateDotPlotData&quot;</span>, <span class="st">&quot;DynRedDimPlot&quot;</span>, <span class="cf">function</span>(x, envir) {</a>
<a class="sourceLine" id="cb10-2" title="2">    commands &lt;-<span class="st"> </span><span class="kw">character</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4">    <span class="cf">if</span> (<span class="op">!</span><span class="kw">exists</span>(<span class="st">&quot;col_selected&quot;</span>, <span class="dt">envir=</span>envir, <span class="dt">inherits=</span><span class="ot">FALSE</span>)) {</a>
<a class="sourceLine" id="cb10-5" title="5">        commands &lt;-<span class="st"> </span><span class="kw">c</span>(commands, </a>
<a class="sourceLine" id="cb10-6" title="6">            <span class="st">&quot;plot.data &lt;- data.frame(X=numeric(0), Y=numeric(0));&quot;</span>)</a>
<a class="sourceLine" id="cb10-7" title="7">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb10-8" title="8">        commands &lt;-<span class="st"> </span><span class="kw">c</span>(commands,</a>
<a class="sourceLine" id="cb10-9" title="9">            <span class="st">&quot;.chosen &lt;- unique(unlist(col_selected));&quot;</span>,</a>
<a class="sourceLine" id="cb10-10" title="10">            <span class="st">&quot;set.seed(100000)&quot;</span>, <span class="co"># to avoid problems with randomization.</span></a>
<a class="sourceLine" id="cb10-11" title="11">            <span class="kw">sprintf</span>(<span class="st">&quot;.coords &lt;- scater::calculate%s(se[,.chosen], ntop=%i, ncomponents=2);&quot;</span>,</a>
<a class="sourceLine" id="cb10-12" title="12">                x[[<span class="st">&quot;Type&quot;</span>]], x[[<span class="st">&quot;NGenes&quot;</span>]]),</a>
<a class="sourceLine" id="cb10-13" title="13">            <span class="st">&quot;plot.data &lt;- data.frame(.coords, row.names=.chosen);&quot;</span>,</a>
<a class="sourceLine" id="cb10-14" title="14">            <span class="st">&quot;colnames(plot.data) &lt;- c(&#39;X&#39;, &#39;Y&#39;);&quot;</span></a>
<a class="sourceLine" id="cb10-15" title="15">        )</a>
<a class="sourceLine" id="cb10-16" title="16">    }</a>
<a class="sourceLine" id="cb10-17" title="17"></a>
<a class="sourceLine" id="cb10-18" title="18">    commands &lt;-<span class="st"> </span><span class="kw">c</span>(commands,</a>
<a class="sourceLine" id="cb10-19" title="19">        <span class="st">&quot;plot.data &lt;- plot.data[colnames(se),,drop=FALSE];&quot;</span>,</a>
<a class="sourceLine" id="cb10-20" title="20">        <span class="st">&quot;rownames(plot.data) &lt;- colnames(se);&quot;</span>)</a>
<a class="sourceLine" id="cb10-21" title="21"></a>
<a class="sourceLine" id="cb10-22" title="22">    <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span>commands), <span class="dt">envir=</span>envir)</a>
<a class="sourceLine" id="cb10-23" title="23"></a>
<a class="sourceLine" id="cb10-24" title="24">    <span class="kw">list</span>(<span class="dt">data_cmds=</span>commands, <span class="dt">plot_title=</span><span class="kw">sprintf</span>(<span class="st">&quot;Dynamic %s plot&quot;</span>, x[[<span class="st">&quot;Type&quot;</span>]]), </a>
<a class="sourceLine" id="cb10-25" title="25">        <span class="dt">x_lab=</span><span class="kw">paste0</span>(x[[<span class="st">&quot;Type&quot;</span>]], <span class="st">&quot;1&quot;</span>), <span class="dt">y_lab=</span><span class="kw">paste0</span>(x[[<span class="st">&quot;Type&quot;</span>]], <span class="st">&quot;2&quot;</span>))</a>
<a class="sourceLine" id="cb10-26" title="26">})</a></code></pre></div>
<p>We use functions from the <em><a href="https://bioconductor.org/packages/3.11/scater">scater</a></em> package to do the actual heavy lifting of calculating the dimensionality reduction results.
The <code>exists()</code> call will check whether any column selection is being transmitted to this panel; if not, it will just return a <code>plot.data</code> variable that contains all <code>NA</code>s such that an empty plot is created.
If <code>col_selected</code> does exist, it contains a list of character vectors specifying the active and saved multiple selections that are being transmitted.
In this case, we do not care about the distinctin between active/saved selections so we just take the union of all of them.</p>
<p>Of course, this is not quite the most efficient way to implement a plotting panel that involves recomputation.
A better approach would be to cache the x/y coordinates and reuse them if only aesthetic parameters have changed,
thus avoiding an unnecessary delay from recomputation.
Doing so requires overriding <code>.renderOutput()</code> to take advantage of the cached contents of the plot,
so for simplicity, we will not do that here.</p>
</div>
<div id="finishing-touches" class="section level2">
<h2><span class="header-section-number">6.6</span> Finishing touches</h2>
<p>For this particular panel class, an additional helpful feature is to override <code>.multiSelectionInvalidated</code>.
This indicates that any brushes or lassos in our plot should be destroyed when we receive a new column selection.
Doing so is the only sensible course of action as the reduced dimension coordinates for one set of samples have no obvious relationship to the coordinates for another set of samples;
having old brushes or lassos hanging around would be of no benefit at best, and be misleading at worst.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">setMethod</span>(<span class="st">&quot;.multiSelectionInvalidated&quot;</span>, <span class="st">&quot;DynRedDimPlot&quot;</span>, <span class="cf">function</span>(x) <span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="in-action" class="section level2">
<h2><span class="header-section-number">6.7</span> In action</h2>
<p>Let’s put our new panel to the test.
We set up an example using our favorite dataset, creating a <code>SingleCellExperiment</code> object with some precomputed dimensionality reduction results.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">library</span>(scRNAseq)</a>
<a class="sourceLine" id="cb12-2" title="2">sce &lt;-<span class="st"> </span><span class="kw">ReprocessedAllenData</span>(<span class="dt">assays=</span><span class="st">&quot;tophat_counts&quot;</span>)</a></code></pre></div>
<pre><code>## snapshotDate(): 2019-12-27</code></pre>
<pre><code>## see ?scRNAseq and browseVignettes(&#39;scRNAseq&#39;) for documentation</code></pre>
<pre><code>## loading from cache</code></pre>
<pre><code>## see ?scRNAseq and browseVignettes(&#39;scRNAseq&#39;) for documentation</code></pre>
<pre><code>## loading from cache</code></pre>
<pre><code>## see ?scRNAseq and browseVignettes(&#39;scRNAseq&#39;) for documentation</code></pre>
<pre><code>## loading from cache</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="kw">library</span>(scater)</a></code></pre></div>
<pre><code>## Loading required package: ggplot2</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">sce &lt;-<span class="st"> </span><span class="kw">logNormCounts</span>(sce, <span class="dt">exprs_values=</span><span class="st">&quot;tophat_counts&quot;</span>)</a>
<a class="sourceLine" id="cb22-2" title="2">sce &lt;-<span class="st"> </span><span class="kw">runPCA</span>(sce, <span class="dt">ncomponents=</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb22-3" title="3">sce &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(sce)</a></code></pre></div>
<p>The plan is to create a (fixed) reduced dimension plot that will transmit to our dynamic reduced dimension plot.
Setting up the iSEE instance is as easy as:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">rdp &lt;-<span class="st"> </span><span class="kw">RedDimPlot</span>(<span class="dt">PanelId=</span>1L)</a>
<a class="sourceLine" id="cb23-2" title="2">drdp &lt;-<span class="st"> </span><span class="kw">new</span>(<span class="st">&quot;DynRedDimPlot&quot;</span>, <span class="dt">SelectColSource=</span><span class="st">&quot;RedDimPlot1&quot;</span>)</a>
<a class="sourceLine" id="cb23-3" title="3">app &lt;-<span class="st"> </span><span class="kw">iSEE</span>(sce, <span class="dt">initial=</span><span class="kw">list</span>(rdp, drdp))</a></code></pre></div>
<p>Brushing at any location in the <code>RedDimPlot</code> will trigger dynamically recompution of results in our <code>DynRedDimPlot</code>.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="the-panel-api.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="case-study-ii.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["iSEE-book.pdf", "iSEE-book.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
